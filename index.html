<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECAT - Summary of Engagement in Creative Arts Therapy</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Bitter:wght@700&display=swap" rel="stylesheet">

<style>
    :root {
        --primary: #2c3e50;
        --bg: #f0f2f5;
        --border: #ccc;
        /* Domain Colors */
        --col-A: #e74c3c; 
        --col-B: #e67e22; 
        --col-C: #f1c40f; 
        --col-D: #27ae60; 
        --col-E: #2980b9; 
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg);
        margin: 0;
        padding: 0;
        color: #333;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }

    /* --------------------------------------------------
       LAYOUT
    -------------------------------------------------- */
    .app-container { display: flex; width: 100%; height: 100%; }

    /* LEFT: EDITOR (Scrollable) */
    .editor-panel {
        width: 35%;
        min-width: 420px;
        background: #fff;
        border-right: 1px solid #ccc;
        overflow-y: auto;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        z-index: 10;
    }

    /* RIGHT: PREVIEW (Scrollable) */
    .preview-panel {
        width: 65%;
        background: #525659;
        overflow-y: auto;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
    }

    /* --------------------------------------------------
       EDITOR STYLES
    -------------------------------------------------- */
    h1 { font-family: 'Bitter', serif; font-size: 1.5rem; color: var(--primary); margin-top:0; }
    h2 { font-size: 1rem; color: #666; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
    
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 600; font-size: 0.8rem; margin-bottom: 4px; }
    
    input, textarea, select {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-family: inherit;
        box-sizing: border-box;
        font-size: 0.9rem;
    }
    textarea { resize: vertical; min-height: 50px; }
    
    /* Distinct style for the Auto-Analysis box to show it's system-generated */
    .auto-analysis {
        background-color: #f9f9f9;
        border-left: 3px solid var(--primary);
        font-style: italic;
        font-size: 0.85rem;
        color: #555;
    }

    .card {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .domain-header-edit {
        font-weight: bold;
        padding: 5px 0;
        margin-bottom: 10px;
        border-bottom: 2px solid #ddd;
        color: var(--primary);
    }

    /* SLIDERS & BANDS */
    .slider-row { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 5px; }
    .slider-group { flex: 1; }
    .range-input { width: 100%; cursor: pointer; accent-color: #555; }
    
    .band-indicator {
        font-size: 0.7rem; font-weight: bold; padding: 2px 6px;
        border-radius: 4px; color: white; background: #ccc;
        display: inline-block; width: 100%; text-align: center;
        margin-bottom: 8px;
    }
    .band-1 { background: #c0392b; } /* Stuck */
    .band-2 { background: #f39c12; } /* Pliance */
    .band-3 { background: #27ae60; } /* Flow */

    .btn {
        background: var(--primary); color: white; border: none;
        padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%;
        margin-bottom: 10px; transition: 0.2s;
    }
    .btn:hover { background: #34495e; }
    .btn-clear { background: #95a5a6; }

    /* --------------------------------------------------
       A4 PREVIEW PAGES (CSS PRINT MAGIC)
    -------------------------------------------------- */
    .a4-page {
        width: 210mm;
        min-height: 296mm; /* Approx A4 height */
        background: white;
        padding: 15mm 15mm; 
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        position: relative;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Hide overflow in preview, print handles break */
    }

    /* HEADER */
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
        flex: 0 0 auto;
    }
    .header-left { display: flex; flex-direction: column; gap: 5px; }
    
    .logo-img { 
        height: 50px; 
        width: auto; 
        object-fit: contain; 
        margin-bottom: 10px; 
        display: block; 
    }

    .report-title { font-family: 'Bitter', serif; font-size: 22px; color: #000; }
    .report-meta { font-size: 11px; text-align: right; line-height: 1.5; color: #444; }

    /* SECTIONS */
    .intro-box {
        background: #f8f9fa;
        padding: 15px;
        border-left: 5px solid var(--primary);
        font-size: 11px;
        line-height: 1.5;
        margin-bottom: 15px;
        color: #444;
        flex: 0 0 auto;
    }

    .quadrant-wrapper {
        flex: 0 0 auto;
        display: flex;
        justify-content: center;
        margin: 0 0 15px 0;
    }

    /* SUMMARY & AIMS BLOCKS */
    .summary-block {
        border: 1px solid #ddd;
        background: #fafafa;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        flex: 0 0 auto;
    }
    .summary-block h4 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    .summary-text { font-size: 11px; white-space: pre-wrap; font-family: 'Inter', sans-serif; }

    /* DOMAINS ON PAGE 2 */
    .domain-section {
        margin-bottom: 20px;
        break-inside: avoid; /* Keep table together on print */
    }
    
    .domain-title-bar {
        color: white;
        padding: 8px 10px;
        font-weight: bold;
        font-size: 14px;
        border-radius: 4px 4px 0 0;
        display: flex;
        justify-content: space-between;
    }

    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        border: 1px solid #ccc;
    }
    .report-table th { background: #eee; padding: 8px; text-align: left; border: 1px solid #ccc; }
    .report-table td { padding: 8px; border: 1px solid #ccc; vertical-align: top; }
    .score-cell { text-align: center; font-weight: bold; width: 40px; }
    
    /* Dynamic Domain Colors */
    .bg-A { background-color: var(--col-A); }
    .bg-B { background-color: var(--col-B); }
    .bg-C { background-color: #d4ac0d; color: black; }
    .bg-D { background-color: var(--col-D); }
    .bg-E { background-color: var(--col-E); }

    .footer {
        margin-top: auto;
        padding-top: 10px;
        border-top: 1px solid #eee;
        font-size: 9px;
        color: #999;
    }

    /* --------------------------------------------------
       PRINT MEDIA QUERY
    -------------------------------------------------- */
    @media print {
        body { background: white; height: auto; overflow: visible; }
        .editor-panel { display: none; }
        .preview-panel { width: 100%; padding: 0; background: white; display: block; }
        .a4-page {
            width: 100%; margin: 0; padding: 15mm; 
            box-shadow: none; page-break-after: always;
            min-height: 0; 
            display: block; /* Flex causes print issues sometimes */
        }
        .a4-page:last-child { page-break-after: auto; }
        button { display: none; }
        * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
</style>
</head>
<body>

<div class="app-container">
    <div class="editor-panel">
        <h1>SECAT Editor</h1>
        
        <div class="form-group">
            <button class="btn" onclick="window.print()">üñ®Ô∏è Save Report as PDF</button>
            <button class="btn btn-clear" onclick="clearAllData()">Clear Form</button>
        </div>

        <div class="card">
            <h2>1. Biographical Info</h2>
            <div class="form-group"><label>Client Name</label><input type="text" id="input-name" oninput="updatePreview()"></div>
            <div class="form-group"><label>Date of Assessment</label><input type="date" id="input-date" oninput="updatePreview()"></div>
            <div class="form-group"><label>Assessor</label><input type="text" id="input-assessor" oninput="updatePreview()"></div>
            <div class="form-group"><label>Service / School</label><input type="text" id="input-service" oninput="updatePreview()"></div>
        </div>

        <div class="card">
            <h2>2. Formulation</h2>
            <label>Executive Summary</label>
            <textarea id="input-summary" oninput="updatePreview()" placeholder="Type the overall summary here..."></textarea>
            <label style="margin-top:10px">Future Aims (One per line)</label>
            <textarea id="input-aims" oninput="updatePreview()" placeholder="1. Aim one..."></textarea>
        </div>

        <div id="domains-editor"></div>
    </div>

    <div class="preview-panel">
        
        <div class="a4-page" id="page-1">
            <div class="report-header">
                <div class="header-left">
                    <img src="https://via.placeholder.com/150x50?text=YOUR+LOGO+HERE" class="logo-img" alt="Logo">
                    <div class="report-title">SECAT Confidential Report</div>
                </div>
                <div class="report-meta">
                    <span id="prev-name">Client Name</span><br>
                    <span id="prev-date">Date</span><br>
                    <span id="prev-assessor">Assessor</span><br>
                    <span id="prev-service">Service</span>
                </div>
            </div>

            <div class="intro-box">
                <strong>What is SECAT?</strong><br>
                The Summary of Engagement in Creative Arts Therapy (SECAT) assesses not just the <em>amount</em> of engagement (Topography), but the <em>quality</em> of the psychological flexibility (Function). 
                <br><br>
                <strong>Understanding the Graph:</strong><br>
                ‚Ä¢ <strong>X-Axis (Flexibility):</strong> Measures adaptability. 0-3 = Rigid/Stuck. 4-6 = Rule-Following/Compliant. 7-10 = Adaptive Flow.<br>
                ‚Ä¢ <strong>Y-Axis (Engagement):</strong> Measures observable skill and participation frequency.
            </div>

            <div class="quadrant-wrapper" id="quadrant-chart"></div>

            <div class="summary-block" id="summary-container">
                <h4>Executive Summary</h4>
                <div id="prev-summary" class="summary-text">No summary provided.</div>
            </div>

            <div class="summary-block" id="aims-container">
                <h4>Future Aims</h4>
                <div id="prev-aims" class="summary-text"></div>
            </div>

            <div class="footer">SECAT¬© 2025. Summary of Engagement in Creative Arts Therapy.</div>
        </div>

        <div class="a4-page" id="page-2">
            <div class="report-header">
                <div class="header-left">
                    <img src="https://via.placeholder.com/150x50?text=YOUR+LOGO+HERE" class="logo-img" alt="Logo">
                    <div class="report-title" style="font-size: 18px;">Assessment Breakdown</div>
                </div>
                <div class="report-meta" id="page2-meta">Client Name</div>
            </div>
            
            <div id="p2-overflow-target"></div>

            <div id="domains-preview">
                </div>

            <div class="footer">SECAT¬© 2025. Summary of Engagement in Creative Arts Therapy.</div>
        </div>
    </div>
</div>

<script>
/* --------------------------------------------------
   DATA CONFIGURATION
-------------------------------------------------- */
const domains = {
    A: { title: "A: Engagement & Participation", color: "#e74c3c", criteria: ["A1. Initiating Play", "A2. Persisting/Adapting", "A3. Attending"] },
    B: { title: "B: Emotional Expression", color: "#e67e22", criteria: ["B1. Expressing Emotions", "B2. Regulatory Use", "B3. Appropriateness"] },
    C: { title: "C: Social Interaction", color: "#f1c40f", criteria: ["C1. Turn-taking", "C2. Collaborating", "C3. Communication Mode"] },
    D: { title: "D: Interaction with Media", color: "#27ae60", criteria: ["D1. Control/Manipulation", "D2. Physical Presence", "D3. Expressive Range"] },
    E: { title: "E: Cognitive Skills", color: "#2980b9", criteria: ["E1. Recalling Moments", "E2. Sequencing Ideas", "E3. Problem Solving"] }
};

// STRICT CRITERIA-MATCHED ANALYSIS (0=Low, 1=Mid, 2=High)
const analysisMap = {
    A: [
        // A1
        ["Engagement limited by rigid adherence to a single idea.", "Initiated only when explicitly prompted (Compliance).", "Initiated new creative ideas spontaneously (Flow)."],
        // A2
        ["Withdrew when musical demand increased (Avoidance).", "Persisted but struggled to adapt to tempo changes.", "Seamlessly adapted play to match context changes."],
        // A3
        ["Play was disconnected from the shared pulse.", "Attended to mechanics rather than the shared music.", "Demonstrated deep contact with the present moment."]
    ],
    B: [
        // B1
        ["Affect was flat or incongruent with activity.", "Labelled emotions correctly but appeared detached.", "Demonstrated congruence between affect and activity."],
        // B2
        ["Used the medium to drown out/mask feelings.", "Expression felt performative or scripted.", "Used the arts to safely hold difficult emotions."],
        // B3
        ["Struggled to tolerate silence or stillness.", "Regulated by strictly controlling the activity.", "Shifted emotional state adaptively."]
    ],
    C: [
        // C1
        ["Struggled to distinguish 'my turn' vs 'your turn'.", "Turn-taking was polite but rule-bound.", "Anticipated the other's entry naturally (I-YOU framing)."],
        // C2
        ["Play was parallel/isolated; ignored social cues.", "Waited for permission to enter the shared space.", "Collaborated to build a shared creative product."],
        // C3
        ["Communication was purely functional (needs-based).", "Social engagement maintained through compliance.", "Communication served to build connection."]
    ],
    D: [
        // D1
        ["Interaction with medium was mechanical/repetitive.", "Used tools correctly but relied on instruction.", "Adapted technical use of medium intuitively."],
        // D2
        ["Physical presence appeared rigid or static.", "Adopted a 'learning' posture; focused on correctness.", "Physical embodiment was congruent with session energy."],
        // D3
        ["Limited to a single dynamic level (e.g., always loud).", "Varied dynamics only when directed (Pliance).", "Utilized full expressive range."]
    ],
    E: [
        // E1
        ["Recall was vague; unable to link past to present.", "Listed events accurately but lacked personal meaning.", "Derived causal connections between action and outcome."],
        // E2
        ["Sequencing was chaotic or stuck in a loop.", "Relied on safe, standard structures.", "Sequencing was logical and creative."],
        // E3
        ["Gave up immediately when problem-solving failed.", "Solved problems by seeking adult help.", "Experimented independently to overcome obstacles."]
    ]
};

/* --------------------------------------------------
   BUILDER & LOGIC
-------------------------------------------------- */
(function initApp() {
    const editorRoot = document.getElementById('domains-editor');
    const previewRoot = document.getElementById('domains-preview');

    if(!editorRoot || !previewRoot) { console.error("Critical Error: DOM elements not found."); return; }

    Object.keys(domains).forEach(key => {
        const d = domains[key];
        
        // 1. EDITOR CARD
        const section = document.createElement('div');
        section.className = 'card';
        section.innerHTML = `<div class="domain-header-edit" style="color:${d.color}">${d.title}</div>`;
        
        d.criteria.forEach((cLabel, idx) => {
            const cid = `${key}${idx+1}`; // e.g., A1
            section.innerHTML += `
                <div style="margin-bottom: 15px;">
                    <label>${cLabel}</label>
                    <div class="slider-row">
                        <div class="slider-group">
                            <span style="font-size:0.7rem">Engagement: <b id="val-eng-${cid}">0</b></span>
                            <input type="range" class="range-input" id="eng-${cid}" min="0" max="10" value="0" oninput="window.handleInput('${cid}', '${key}', ${idx})">
                        </div>
                        <div class="slider-group">
                            <span style="font-size:0.7rem">Flexibility: <b id="val-flex-${cid}">0</b></span>
                            <input type="range" class="range-input" id="flex-${cid}" min="0" max="10" value="0" oninput="window.handleInput('${cid}', '${key}', ${idx})">
                        </div>
                    </div>
                    <div class="band-indicator band-1" id="band-${cid}">0 - Stuck</div>
                    
                    <div style="margin-top:5px;">
                        <label style="font-size:0.7rem; color:#888;">Analysis (Auto-Generated)</label>
                        <textarea id="auto-${cid}" class="auto-analysis" oninput="window.updatePreview()"></textarea>
                        <label style="font-size:0.7rem; color:#888; margin-top:5px;">Additional Notes</label>
                        <textarea id="note-${cid}" placeholder="Context..." oninput="window.updatePreview()"></textarea>
                    </div>
                </div>
            `;
        });
        
        section.innerHTML += `<label>Overall ${key} Summary</label><textarea id="sum-${key}" oninput="window.updatePreview()"></textarea>`;
        editorRoot.appendChild(section);

        // 2. PREVIEW SECTION
        const prevDiv = document.createElement('div');
        prevDiv.className = 'domain-section';
        const bgClass = `bg-${key}`;
        
        prevDiv.innerHTML = `
            <div class="domain-title-bar ${bgClass}">
                <span>${d.title}</span>
            </div>
            <table class="report-table">
                <thead>
                    <tr><th width="35%">Criteria</th><th width="8%">Eng.</th><th width="8%">Flex.</th><th>Analysis & Notes</th></tr>
                </thead>
                <tbody id="tbody-${key}"></tbody>
            </table>
            <div id="prev-sum-${key}" style="font-size:11px; padding:10px; background:#fafafa; border:1px solid #ccc; border-top:0; font-style:italic;"></div>
        `;
        previewRoot.appendChild(prevDiv);
    });
    
    setTimeout(window.updatePreview, 100);
})();

// GLOBAL HANDLERS
window.handleInput = function(cid, domainKey, cIdx) {
    const eng = document.getElementById(`eng-${cid}`).value;
    const flex = document.getElementById(`flex-${cid}`).value;
    
    document.getElementById(`val-eng-${cid}`).innerText = eng;
    document.getElementById(`val-flex-${cid}`).innerText = flex;

    // Update Band
    const bandEl = document.getElementById(`band-${cid}`);
    let bandIdx = 0; // 0=Low, 1=Mid, 2=High
    
    if (flex <= 3) {
        bandEl.className = "band-indicator band-1";
        bandEl.innerText = `${flex} - Rigid/Stuck`;
        bandIdx = 0;
    } else if (flex <= 6) {
        bandEl.className = "band-indicator band-2";
        bandEl.innerText = `${flex} - Pliance/Rule`;
        bandIdx = 1;
    } else {
        bandEl.className = "band-indicator band-3";
        bandEl.innerText = `${flex} - Flow/Adaptive`;
        bandIdx = 2;
    }

    // AUTO-POPULATE ANALYSIS
    // Only if slider moved.
    const phrase = analysisMap[domainKey][cIdx][bandIdx];
    const autoBox = document.getElementById(`auto-${cid}`);
    autoBox.value = phrase;

    window.updatePreview();
    window.updateChart();
};

window.updatePreview = function() {
    // Headers
    document.getElementById('prev-name').innerText = document.getElementById('input-name').value || "Client Name";
    document.getElementById('page2-meta').innerText = document.getElementById('input-name').value || "Client Name";
    document.getElementById('prev-date').innerText = document.getElementById('input-date').value || "Date";
    document.getElementById('prev-assessor').innerText = document.getElementById('input-assessor').value || "Assessor";
    document.getElementById('prev-service').innerText = document.getElementById('input-service').value || "Service";

    // Formulation
    document.getElementById('prev-summary').innerText = document.getElementById('input-summary').value || "No summary provided.";
    
    // Aims
    const aimsTxt = document.getElementById('input-aims').value;
    const aimsDiv = document.getElementById('prev-aims');
    aimsDiv.innerHTML = "";
    if (aimsTxt) {
        const ul = document.createElement('ul');
        ul.style.margin = "0"; ul.style.paddingLeft = "15px";
        aimsTxt.split('\n').forEach(line => {
            if(line.trim()) ul.innerHTML += `<li>${line}</li>`;
        });
        aimsDiv.appendChild(ul);
    }

    // Tables
    Object.keys(domains).forEach(key => {
        const tbody = document.getElementById(`tbody-${key}`);
        if(tbody) {
            tbody.innerHTML = "";
            domains[key].criteria.forEach((cLabel, idx) => {
                const cid = `${key}${idx+1}`;
                const eng = document.getElementById(`eng-${cid}`).value;
                const flex = document.getElementById(`flex-${cid}`).value;
                const autoTxt = document.getElementById(`auto-${cid}`).value;
                const noteTxt = document.getElementById(`note-${cid}`).value;
                
                // Combine texts for report
                let combinedTxt = autoTxt;
                if(noteTxt) combinedTxt += ` <br><em>Note: ${noteTxt}</em>`;

                tbody.innerHTML += `
                    <tr>
                        <td>${cLabel}</td>
                        <td class="score-cell" style="background:${eng > 0 ? '#eee' : '#fff'}">${eng}</td>
                        <td class="score-cell" style="background:${getFlexColor(flex)}">${flex}</td>
                        <td>${combinedTxt}</td>
                    </tr>
                `;
            });
            document.getElementById(`prev-sum-${key}`).innerText = document.getElementById(`sum-${key}`).value;
        }
    });
    
    window.checkPagination();
    window.updateChart();
};

// PAGINATION LOGIC
window.checkPagination = function() {
    const page1 = document.getElementById('page-1');
    const summaryBox = document.getElementById('summary-container');
    const aimsBox = document.getElementById('aims-container');
    const p2Target = document.getElementById('p2-overflow-target');
    
    // 1. Reset: Move aims back to P1 to measure
    summaryBox.after(aimsBox);
    
    // 2. Check Height (Approx 1080px is safe for A4 minus margins)
    if (page1.scrollHeight > 1080) {
        // 3. Overflow detected: Move aims to P2
        p2Target.appendChild(aimsBox);
    }
};

window.getFlexColor = function(val) {
    if (val == 0) return "#fff";
    if (val <= 3) return "#fadbd8"; 
    if (val <= 6) return "#fdebd0"; 
    return "#d5f5e3"; 
};

window.updateChart = function() {
    const container = document.getElementById('quadrant-chart');
    if(!container) return;
    container.innerHTML = ""; 
    
    // INCREASED MARGIN TO 60 TO PREVENT CLIPPING
    const width = 400, height = 400, margin = 60;
    const svg = d3.select("#quadrant-chart").append("svg")
        .attr("width", width).attr("height", height)
        .attr("viewBox", `0 0 ${width} ${height}`);

    const g = svg.append("g").attr("transform", `translate(${margin},${margin})`);
    const innerW = width - margin*2;
    const innerH = height - margin*2;
    
    const x = d3.scaleLinear().domain([0, 10]).range([0, innerW]);
    const y = d3.scaleLinear().domain([0, 10]).range([innerH, 0]);

    g.append("rect").attr("width", innerW).attr("height", innerH).attr("fill", "#fff").attr("stroke", "#333");
    g.append("line").attr("x1", innerW/2).attr("y1", 0).attr("x2", innerW/2).attr("y2", innerH).attr("stroke", "#ccc").attr("stroke-dasharray", "4");
    g.append("line").attr("x1", 0).attr("y1", innerH/2).attr("x2", innerW).attr("y2", innerH/2).attr("stroke", "#ccc").attr("stroke-dasharray", "4");

    g.append("text").attr("x", innerW-5).attr("y", innerH/2 - 5).text("Flow").attr("text-anchor", "end").style("font-size", "10px");
    g.append("text").attr("x", 5).attr("y", innerH/2 - 5).text("Rigid").attr("text-anchor", "start").style("font-size", "10px");
    g.append("text").attr("x", innerW/2 + 5).attr("y", 10).text("High Eng.").attr("text-anchor", "start").style("font-size", "10px");
    g.append("text").attr("x", innerW/2 + 5).attr("y", innerH - 5).text("Low Eng.").attr("text-anchor", "start").style("font-size", "10px");

    // Data
    let points = [];
    Object.keys(domains).forEach(key => {
        domains[key].criteria.forEach((_, idx) => {
            const cid = `${key}${idx+1}`;
            const eng = +document.getElementById(`eng-${cid}`).value;
            const flex = +document.getElementById(`flex-${cid}`).value;
            if (eng > 0 || flex > 0) {
                points.push({ id: cid, eng: eng, flex: flex, color: domains[key].color });
            }
        });
    });

    const grouped = {};
    points.forEach(p => {
        const key = `${p.flex}-${p.eng}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(p);
    });

    let finalData = [];
    Object.values(grouped).forEach(group => {
        if (group.length === 1) {
            group[0].dx = 0; group[0].dy = 0;
            finalData.push(group[0]);
        } else {
            const radius = 12; 
            const step = (2 * Math.PI) / group.length;
            group.forEach((p, i) => {
                p.dx = Math.cos(step * i) * radius;
                p.dy = Math.sin(step * i) * radius;
                finalData.push(p);
            });
        }
    });

    g.selectAll("circle")
        .data(finalData).enter().append("circle")
        .attr("cx", d => x(d.flex) + d.dx)
        .attr("cy", d => y(d.eng) + d.dy)
        .attr("r", 6)
        .attr("fill", d => d.color)
        .attr("stroke", "#fff").attr("stroke-width", 1);

    g.selectAll(".label")
        .data(finalData).enter().append("text")
        .attr("x", d => x(d.flex) + d.dx)
        .attr("y", d => y(d.eng) + d.dy - 8)
        .text(d => d.id)
        .attr("text-anchor", "middle")
        .attr("font-size", "9px")
        .attr("font-weight", "bold")
        .attr("fill", "#333");
};

window.clearAllData = function() {
    if(confirm("Clear all data?")) {
        document.querySelectorAll('input').forEach(el => el.value = '');
        document.querySelectorAll('textarea').forEach(el => el.value = '');
        document.querySelectorAll('input[type="range"]').forEach(el => el.value = 0);
        
        Object.keys(domains).forEach(k => {
            domains[k].criteria.forEach((_, i) => window.handleInput(`${k}${i+1}`, k, i));
        });
        window.updatePreview();
    }
};
</script>
</body>
</html>
